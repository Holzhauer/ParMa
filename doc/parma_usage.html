<html>

<head>
	<title>ParMa: Usage</title>
	<LINK REL="stylesheet" TYPE="text/css" HREF="stylesheet.css" TITLE="Style">
	<LINK REL="stylesheet" TYPE="text/css" HREF="stylesheet_java.css" TITLE="Style">
</head>

<body>	
<h5>Last update: 24.01.2012</h5>
<h1>ParMa Usage</h1>

	<h2>Using this Documentation</h2>
		<p class="text">First, read section <a href="#getwork">Getting ParMa to work</a>. Then, read the hints to the specific
		parameter readers <a href="readers">below</a>.</p>
		<p class="rs">Text written like this indicates Repast Simphony specific instructions.</p>
	
	<h2>The Concept</h2>
	<p class="text">
	The <code>ParameterManager</code> is the central unit of the ParameterFramework. Its <code>init()</code> method
	is called to read in available parameter data. The way to accomplish that task is defined by <code>PmParameterReader</code>s
	that are registered at the <code>PmParameterManager</code> and have a <code>initParameters()</code> method that is called
	from the  manager. If no parameter values are read in, the parameter manager steps back to the default value defined in 
	<code>ParameterDefinition</code>.
	</p>
	
    <h3>The Framework</h3>
	<p class="text">The framework's center is the <code>MParameterManager</code>:</p>
	<ul>
		<li><code>ParameterDefinition</code>s are registered at the manager, for instance by calling
		<code>ParameterManager.registerParametersDefinitions(Arrays.asList(SqlPa.values()));</code>.</li>
		<li>Parameter values are retrieved from the manager by calling <code>getParameter(ParameterDefinition parameter)</code>.</li>
		<li>Its <code>init()</code> method is called to read in available parameter data. The way to
	accomplish that task is defined by <code>ParameterReader</code>s that are registered at the <code>MParameterManager</code> by
	<code>registerReader(ParameterReader reader)</code>. The have a <code>initParameters()</code> method that is called from the 
	manager. If no parameter values are read in, the parameter manager steps back to the default value defined in 
	<code>ParameterDefinition</code>.
	</ul>
	
	<h2><a name="getwork">Getting ParMa to work</a></h2>
	
	<ol><li><b>Create parameter definitions</b>
	<p>First, <code>ParameterDefinitions</code> need to be created. For convenience, these parameter definitions
	are defined by an enumeration, as the following example shows:</p>

	<div class="java"><code class="java"><span class="java4">public enum </span><span class="java10">PmFrameworkPa </span><span class="java4">implements </span><span class="java10">PmParameterDefinition </span>{<br>
	&#xA0; <br>
	&#xA0; <span class="java14">/**<br />
	&#xA0;&#xA0; *&#xA0; Location of XML file that specifies database settings:<br />
	&#xA0;&#xA0; */<br />
	&#xA0; </span><span class="java10">DB_SETTINGS_FILE</span><span class="java8">(</span><span class="java10">String.class, </span><span class="java5">&#34;./DbSettings.xml&#34;</span><span class="java8">)</span><span class="java10">;<br />
	&#xA0; <br />
	<br />
	&#xA0; </span><span class="java4">private </span><span class="java10">Class &lt; ? &gt;&#xA0; type;<br />
	&#xA0; </span><span class="java4">private </span><span class="java10">Object&#xA0;&#xA0;&#xA0; defaultValue;<br />
	<br />
	&#xA0; PmFrameworkPa</span><span class="java8">(</span><span class="java10">Class&lt;?&gt; type</span><span class="java8">) {<br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">this</span><span class="java8">(</span><span class="java10">type, </span><span class="java4">null</span><span class="java8">)</span><span class="java10">;<br />
	&#xA0; </span><span class="java8">}<br />
	<br />
	&#xA0; </span><span class="java10">PmFrameworkPa</span><span class="java8">(</span><span class="java10">Class&lt;?&gt; type, Object defaultValue</span><span class="java8">) {<br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">this</span><span class="java10">.type = type;<br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">this</span><span class="java10">.defaultValue = defaultValue;<br />
	&#xA0; </span><span class="java8">}<br />
	<br />
	&#xA0; </span><span class="java4">public </span><span class="java10">Class &lt; ? &gt; getType</span><span class="java8">() {<br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">return </span><span class="java10">type;<br />
	&#xA0; </span><span class="java8">}<br />
	<br />
	&#xA0; </span><span class="java4">public </span><span class="java10">Object getDefaultValue</span><span class="java8">() {<br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">return </span><span class="java10">defaultValue;<br />
	&#xA0; </span><span class="java8">}<br />
	}</span></code></div>
	</li>
	
	<li><b>Model Initialisation</b> 
	
	<p class="text"> Consider the following steps during model initialisation to initialise ParMa properly:</p>
	<ol>
		<li>
		One or more <code>ParameterReaders</code> are registered at the parameter manager: 
		
		<div class="java"><code class="java"><span class="java10">PmParameterManager.registerReader</span><span class="java8">(</span><span class="java4">new </span><span class="java10">PmXmlParameterReader</span><span class="java8">())</span><span class="java10">;</span></code></div>
		</li>
		<li>
		Then, trigger the parameter manager to read in parameter values:
		<div class="java"><code class="java"><span class="java10">PmParameterManager.init</span><span class="java8">()</span><span class="java10">;</span></code></div>
		Parameter readers are initialised in the order they were registered at the manager.
		</li>
	
	</ol></li>
	
	<li><b>Access Parameter Values</b>
		<p class="text">
		Finally, You will access the parameter values like this:</p>
		<div class="java"><code class="java"><span class="java9">int </span><span class="java10">num_total = </span><span class="java8">((</span><span class="java10">Integer</span><span class="java8">)</span><span class="java10">PmParameterManager.getParameter</span><span class="java8">(</span><span class="java10">BasicPa.NUM_AGENTS</span><span class="java8">))</span><span class="java10">.intValue</span><span class="java8">()</span><span class="java10">;</span></code></div>
	</li>
	</ol>
	
	<h2><a name="readers">Parameter Readers</a></h2>
	
	<h3>PmDbParameterReader</h3>
	<p class="text">The <code>PmDbParameterReader</code> connects to a MySQL database using PmFrameworkPa.LOCATION, 
	PmFrameworkPa.DBNAME, PmFrameworkPa.USER, and PmFrameworkPa.PASSWORD and fetches parameter values from a
	specific row (PmFrameworkPa.PARAM_SET_ID) of a certain table (PmFrameworkPa.TBLNAME_PARAMS).
	
	There are two ways to set values for these parameters:
	<ol>
		<li><code>PmDbXmlParameterReader</code> reads the database settings from an XML-File.
		The <code>PmDbXmlParameterReader</code> also should be registered at the <code>ParameterManager</code> before the
		<code>PmDbParameterReader</code>.</li>
		
		<li>Set the parameters via Java code before <code>PmParameterManager.init()</code> is called:
<div class="java"><code class="java"><span class="java0">&#xA0;&#xA0;&#xA0; </span><span class="java10">PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.LOCATION, </span><span class="java5">&#34;localhost&#34;</span><span class="java8">)</span><span class="java10">;<br />
&#xA0;&#xA0;&#xA0; PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.DBNAME, </span><span class="java5">&#34;agentbm&#34;</span><span class="java8">)</span><span class="java10">;<br />
&#xA0;&#xA0;&#xA0; PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.USER, </span><span class="java5">&#34;modeller&#34;</span><span class="java8">)</span><span class="java10">;<br />
&#xA0;&#xA0;&#xA0; PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.PASSWORD, </span><span class="java5">&#34;password&#34;</span><span class="java8">)</span><span class="java10">;<br />
&#xA0;&#xA0;&#xA0; PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.TBLNAME_PARAMS, </span><span class="java5">&#34;params&#34;</span><span class="java8">)</span><span class="java10">;</span></code></div>
		</li>
	</ol>
	<p class="text">The parameter definition that contains the parameter set id for which parameter definitions 
	shall be fetched from DB may be passed by the constructor. Otherwise, the parameter set id needs to be assigned to
	<code>PmFramworkPa#PARAM_SET_ID</code>. Use the following syntax to pass your custom parameter set id parameter
	to the framework:</p>

<div class="java"><code class="java"><span class="java0">&#xA0;&#xA0;&#xA0; </span><span class="java10">PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.PARAM_SET_ID, <br />
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PmParameterManager.getParameter</span><span class="java8">(</span><span class="java10">BasicPa.PARAM_SET_ID</span><span class="java8">))</span><span class="java10">;</span></code></div>
	
	<p class="text">Column names for parameters require the form <code>&lt;package&gt;.&lt;Enumeration&gt;:&lt;PARAMETER_NAME&gt;</code>. Note
	that you need to specify quotes around these constructs in SQL. The param set id translates the column named "id" within the table.</p>
	
	<h3>PmXmlParameterReader</h3>
	<p class="text"><code>PmXmlParameterReader</code> parses parameter data that is specified in an XML file.
	As in database tables, parameter names need to given in the form <code>&lt;package&gt;.&lt;Enumeration&gt;:&lt;PARAMETER_NAME&gt;.</code> 
	XML parameter files look like this:</p>
	
	<div class="java">
	<code>
	&lt;?xml version="1.0"?&gt;<br>
&lt;parameters&gt;<br>
	&lt;de.cesr.parma.tests.BasicPa:NUM_AGENTS&gt;100&lt;/de.cesr.parma.tests.BasicPa:NUM_AGENTS&gt;<br>
	&lt;de.cesr.parma.tests.BasicPa:MUE&gt;0.1&lt;/de.cesr.parma.tests.BasicPa:MUE&gt;<br>
&lt;/parameters&gt;
	</code> </div>
	
	<p class="text">The <code>PmXmlParameterReader</code> is useful to provide default parameter values that
	are not hard-coded (initialise the reader at first) or to override parameter value, e.g. from database
	in order to test certain settings (initialise the reader at last). Note that you may validate the run information
	mechanism in the latter case!</p>
	
	<h3>PmDdXmlParameterReader</h3>
	<p class="text">The <code>PmDbXmlParameterReader</code> is a special version of 
	<code>PmXmlParameterReader</code> and reads in database settings specified in an XML-file hose name and location is defined in <code>MoreBasicPa</code>. The XML-File
	is given by <code>PmFrameworkPa.DB_SETTINGS_FILE</code>. It is registered at the <code>PmParameterManager</code> by default.</p>
	
	<h3>PmGuiParameterReader</h3>
	<p class="text">The <code>PmGuiParameterReader</code> currently is not ready for use.</p>
	
	<h2>Special Applications</h2>
	<h3>Use more than one Database source</h3>
	<p class="text">In case more than one database sources (also true when more than one tables in the same
	database shall be accessed) shall be used, one need to initialise parameters in several steps:</p>

	<div class="java"><code class="java"><span class="java0">&#xA0;&#xA0;&#xA0; </span><span class="java10">PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.XML_PARAMETER_FILE, <br />
	&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PmParameterManager.getParameter</span><span class="java8">(</span><span class="java10">BasicPa.XML_PARAMETER_FILE</span><span class="java8">))</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.DB_SETTINGS_FILE,<br />
	&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="java5">&#34;./config/DBSettings.xml&#34;</span><span class="java8">)</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; <br />
	&#xA0;&#xA0;&#xA0; PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.PARAM_SET_ID, <br />
	&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PmParameterManager.getParameter</span><span class="java8">(</span><span class="java10">BasicPa.PARAM_SET_ID</span><span class="java8">))</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; <br />
	&#xA0;&#xA0;&#xA0; PmParameterManager.registerReader</span><span class="java8">(</span><span class="java4">new </span><span class="java10">PmDbXmlParameterReader</span><span class="java8">())</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; PmParameterManager.registerReader</span><span class="java8">(</span><span class="java4">new </span><span class="java10">PmDbParameterReader</span><span class="java8">(</span><span class="java10">BasicPa.PARAM_SET_ID</span><span class="java8">))</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; PmParameterManager.registerReader</span><span class="java8">(</span><span class="java4">new </span><span class="java10">MilieuPrefDataReader</span><span class="java8">())</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; <br />
	&#xA0;&#xA0;&#xA0; PmParameterManager.init</span><span class="java8">()</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; <br />
	&#xA0;&#xA0;&#xA0; PmParameterManager.setParameter</span><span class="java8">(</span><span class="java10">PmFrameworkPa.DB_SETTINGS_FILE, <br />
	&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="java5">&#34;./config/DBSettingsSocNet.xml&#34;</span><span class="java8">)</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; <br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">new </span><span class="java10">PmDbXmlParameterReader</span><span class="java8">()</span><span class="java10">.initParameters</span><span class="java8">()</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">new </span><span class="java10">PmDbParameterReader</span><span class="java8">(</span><span class="java10">SocNetPa.SOCNET_PARAM_ID</span><span class="java8">)</span><span class="java10">.initParameters</span><span class="java8">()</span><span class="java10">;<br />
	&#xA0;&#xA0;&#xA0; <br />
	&#xA0;&#xA0;&#xA0; </span><span class="java4">new </span><span class="java10">PmXmlParameterReader</span><span class="java8">()</span><span class="java10">.initParameters</span><span class="java8">()</span><span class="java10">;</span></code></div>
	
	<ul>
		<li>First, XML file locations for a <code>PmXmlParameterReader</code> and <code>PmDbXmlParameterReader</code> are passed from custom parameter
		definitions to the ParMa framework definitions. Often, the file locations are hard coded in custom Java code.</li>
		<li>Furthermore, the param set id is copied from custom parameter definition.
			<p class="rs">Note, for Repast Simphony batch runs you need to ensure that the parameter set id from the RS parameter scheme are
			passed to ParMa before any <code>PmDbParameterReader</code> are initialised! You then may not override teh RS settings by
			copying custom definitions!</p></li>
		<li>Afterwards, we register a number of readers including the <code>PmDbXmlParameterReader</code> and the first <code>PmDbParameterReader</code> 
		at the <code>PmParameterManager</code> that are initialised afterwards in the given order.</li>
		<li>We then set another XML file as <code>DB_SETTINGS_FILE</code> to read parameter from another table.</li>
		<li>Then, <code>PmDbXmlParameterReader</code> is initialised directly (thus, there is no need to register readers at <code>PmParameterManager</code>),
		and the second <code>PmDbParameterReader</code> is initialised directly as well.
	</ul>
	<h2>Known Problems</h2>
	<h3>Parallel Computing</h3>
	<p class="text">For instance, if you want to instantiate in parallel several objects of a class with 
	different parameter values using ParMa this could cause problems. The various instantiation
	processes all access the same parameter through ParMa. Therefore, it is hard to assign
	various values to the same parameter without causing side effects.</p>
<body>
</html>